{
  "name": "AgentFirstStep",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "calendarId": {
          "__rl": true,
          "value": "workout.coach84@gmail.com",
          "mode": "list",
          "cachedResultName": "workout.coach84@gmail.com"
        },
        "triggerOn": "eventEnded",
        "options": {}
      },
      "id": "375490b3-8af8-4056-b8a4-b943fcc2a27f",
      "name": "Fin de Sesion",
      "type": "n8n-nodes-base.googleCalendarTrigger",
      "typeVersion": 1,
      "position": [
        -1392,
        528
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "Qm082Rxs35dspb00",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1aBHq7kbht7t6HqLX3WAKscanIa_OP5n1BU_IMZQCsnQ",
          "mode": "list",
          "cachedResultName": "datos_clientes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aBHq7kbht7t6HqLX3WAKscanIa_OP5n1BU_IMZQCsnQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aBHq7kbht7t6HqLX3WAKscanIa_OP5n1BU_IMZQCsnQ/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Nombre",
              "lookupValue": "={{ $json.summary.split(': ')[1] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e4a85c37-51a6-47eb-ab1c-a90ec9b2193e",
      "name": "Buscar Cliente",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [
        -1168,
        528
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "5C2Z3z7j47bLCAW5",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aBHq7kbht7t6HqLX3WAKscanIa_OP5n1BU_IMZQCsnQ",
          "mode": "list",
          "cachedResultName": "datos_clientes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aBHq7kbht7t6HqLX3WAKscanIa_OP5n1BU_IMZQCsnQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aBHq7kbht7t6HqLX3WAKscanIa_OP5n1BU_IMZQCsnQ/edit#gid=0"
        },
        "columnToMatchOn": "Nombre",
        "valueToMatchOn": "={{ $json.Nombre }}",
        "fieldsUi": {
          "values": [
            {
              "column": "=Sesiones_restantes",
              "fieldValue": "={{ $node[\"Buscar Cliente\"].json[\"Sesiones_restantes\"] - 1 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "bc2b8683-e359-4016-bc4c-d64368fdc76f",
      "name": "Descontar Sesion",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [
        -960,
        528
      ],
      "values": {
        "fields": [
          {
            "name": "Sesiones Restantes",
            "value": "={{$node[\"Buscar Cliente\"].json[\"Sesiones Restantes\"] - 1}}"
          }
        ]
      },
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "5C2Z3z7j47bLCAW5",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$node[\"Descontar Sesion\"].json[\"Sesiones_restantes\"]}}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "112cb26e-0100-4af6-a925-058b7cceb7d7",
      "name": "Tiene Sesiones?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -736,
        528
      ]
    },
    {
      "parameters": {
        "jsCode": "const eventosCalendar = $items('Comprobar disponibilidad');\nconst infoCliente = $('Buscar Cliente').item.json;\n\n// 1. Extraer datos con los nombres exactos que vienen de tu Sheets\nconst nombreReal = infoCliente.Nombre; // Importante: MayÃºscula\nconst emailReal = infoCliente.Email;   // Importante: MayÃºscula\nconst sesiones = infoCliente.Sesiones_restantes;\n\nconst ocupadoISO = eventosCalendar.map(e => new Date(e.json.start.dateTime).toISOString());\n\nconst ahora = new Date();\nconst slotsPorDia = { \"lunes\": [], \"martes\": [], \"miÃ©rcoles\": [], \"jueves\": [], \"viernes\": [] };\n\nlet proximoLunes = new Date(ahora);\nconst diasHastaLunes = (8 - ahora.getDay()) % 7 || 7; \nproximoLunes.setDate(ahora.getDate() + diasHastaLunes);\nproximoLunes.setHours(0, 0, 0, 0);\n\nfor (let i = 0; i < 5; i++) {\n  let fechaBase = new Date(proximoLunes);\n  fechaBase.setDate(proximoLunes.getDate() + i);\n  const diaNombre = fechaBase.toLocaleString('es-ES', { weekday: 'long' }).toLowerCase();\n\n  const bloques = [\n    { inicio: 9, fin: 13 },     // Bloque maÃ±ana\n    { inicio: 15.5, fin: 19 }   // Bloque tarde (ajustado para que salgan mÃ¡s horas)\n  ];\n\n  bloques.forEach(bloque => {\n    let horaActual = new Date(fechaBase);\n    let [hInicio, mInicio] = String(bloque.inicio).split('.');\n    horaActual.setHours(parseInt(hInicio), mInicio ? 30 : 0, 0, 0);\n\n    let horaFinBloque = new Date(fechaBase);\n    let [hFin, mFin] = String(bloque.fin).split('.');\n    horaFinBloque.setHours(parseInt(hFin), mFin ? 30 : 0, 0, 0);\n\n    while (horaActual < horaFinBloque) {\n      const isoString = horaActual.toISOString();\n      const estaOcupado = ocupadoISO.includes(isoString);\n      const label = horaActual.toLocaleString('es-ES', { hour: '2-digit', minute: '2-digit' });\n\n      // CORRECCIÃ“N AQUÃ: Usamos las variables nombreReal y emailReal\n      const webhookUrl = `https://workoutcoach.app.n8n.cloud/webhook-test/seleccion-horario?fecha=${isoString}&email=${emailReal}&nombre=${encodeURIComponent(nombreReal)}`;\n\n      slotsPorDia[diaNombre].push({\n        label,\n        url: webhookUrl,\n        ocupado: estaOcupado\n      });\n      \n      horaActual.setMinutes(horaActual.getMinutes() + 45); // Sesiones de 45 min\n    }\n  });\n}\n\n// GeneraciÃ³n de HTML\nlet htmlBotones = `<div style=\"font-family: sans-serif; max-width: 600px;\">`;\nfor (const [dia, horas] of Object.entries(slotsPorDia)) {\n  htmlBotones += `<h3 style=\"text-transform: capitalize; border-bottom: 2px solid #eee; padding-top:10px;\">${dia}</h3>`;\n  htmlBotones += `<div style=\"display: block;\">`;\n  horas.forEach(slot => {\n    if (slot.ocupado) {\n      htmlBotones += `<span style=\"display: inline-block; background-color: #ff4d4d; color: white; padding: 8px 12px; margin: 4px; border-radius: 4px; font-size: 14px; text-decoration: line-through;\">${slot.label}</span>`;\n    } else {\n      htmlBotones += `<a href=\"${slot.url}\" style=\"display: inline-block; background-color: #28a745; color: white; padding: 8px 12px; margin: 4px; border-radius: 4px; text-decoration: none; font-size: 14px; font-weight: bold;\">${slot.label}</a>`;\n    }\n  });\n  htmlBotones += `</div>`;\n}\nhtmlBotones += `</div>`;\n\nreturn { \n  htmlBotones,\n  cliente: nombreReal,\n  email: emailReal,\n  sesionesRestantes: sesiones\n};"
      },
      "id": "a6ee1379-5e65-4da4-8bdd-14de0c3c648d",
      "name": "Generar Horarios",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        432
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $node[\"Buscar Cliente\"].json[\"Email\"] }}",
        "subject": "Reserva tu prÃ³xima sesiÃ³n",
        "message": "={{ '<div style=\"font-family: Arial, sans-serif; color: #333;\">' +\n'<h2>Â¡Hola ' + $json.cliente + '! ðŸ‘‹</h2>' +\n'<p>Te quedan <b>' + $json.sesionesRestantes + ' sesiones</b> en tu bono.</p>' +\n'<p>Por favor, elige tu horario para la semana que viene:</p>' +\n'<div style=\"margin-top: 20px;\">' +\n$json.htmlBotones + \n'</div>' +\n'<p style=\"margin-top: 30px; font-size: 12px; color: #777;\"><i>Nota: Los horarios en rojo ya estÃ¡n reservados.</i></p>' +\n'</div>' }}",
        "options": {}
      },
      "id": "35d1ef4b-5b64-42e7-b8d1-7f7fdd2285db",
      "name": "Mail con Calendario",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -224,
        432
      ],
      "webhookId": "d64ef27b-9229-49e3-94a3-340331009e40",
      "credentials": {
        "gmailOAuth2": {
          "id": "TWPomNKuGhKONfTk",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.Email }}",
        "subject": "Â¡Gracias por tus sesiones!",
        "message": "<p>Â¡Hola! Has completado tu Ãºltima sesiÃ³n de entrenamiento hoy.</p> <p>Â¡Enhorabuena por el esfuerzo! Has terminado tu bono de sesiones. Si quieres seguir dÃ¡ndole caÃ±a, puedes renovar tu bono en el siguiente enlace:</p> <a href=\"URL_TU_TIENDA\" style=\"color:#1a73e8;\">Comprar nuevo bono de sesiones</a>",
        "options": {}
      },
      "id": "80d77c66-3f2e-4c86-8c96-604ffe74e465",
      "name": "Mail Despedida",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -512,
        624
      ],
      "webhookId": "cddb5539-bf31-4f70-9997-bf3e5d73d096",
      "credentials": {
        "gmailOAuth2": {
          "id": "TWPomNKuGhKONfTk",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "workout.coach84@gmail.com",
          "mode": "list",
          "cachedResultName": "workout.coach84@gmail.com"
        },
        "returnAll": true,
        "timeMin": "={{ new Date(new Date().setDate(new Date().getDate() + ((8 - new Date().getDay()) % 7 || 7))).toISOString().split('T')[0] + 'T00:00:00Z' }}",
        "timeMax": "={{ new Date(new Date().setDate(new Date().getDate() + ((8 - new Date().getDay()) % 7 || 7) + 5)).toISOString().split('T')[0] + 'T23:59:59Z' }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -576,
        432
      ],
      "id": "90c7ce93-c803-41a8-bc97-dac7e16685be",
      "name": "Comprobar disponibilidad",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "Qm082Rxs35dspb00",
          "name": "Google Calendar account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Fin de Sesion": {
      "main": [
        [
          {
            "node": "Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Cliente": {
      "main": [
        [
          {
            "node": "Descontar Sesion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descontar Sesion": {
      "main": [
        [
          {
            "node": "Tiene Sesiones?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tiene Sesiones?": {
      "main": [
        [
          {
            "node": "Comprobar disponibilidad",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mail Despedida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Horarios": {
      "main": [
        [
          {
            "node": "Mail con Calendario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Comprobar disponibilidad": {
      "main": [
        [
          {
            "node": "Generar Horarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "595db655-8fdc-4253-b041-4dfe01da793e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "725588a2e8e026408b79868db1662540f168dd425a75b410a8221b46e5b4994c"
  },
  "id": "X-KknjVO__mvgBTm-uw0B",
  "tags": []
}